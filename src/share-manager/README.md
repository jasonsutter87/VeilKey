# ShareManager - Secure Share Storage & Access Control

The ShareManager provides secure storage, role-based access control, and audit logging for threshold key shares generated by VeilKey.

## Features

- **Encrypted Storage**: AES-256-GCM encryption with PBKDF2 key derivation
- **Access Control**: Role-based permissions (admin, trustee, auditor)
- **Audit Logging**: Tamper-evident hash chain for all share access
- **Storage Options**: In-memory (testing) or file-based (production)
- **Share Assignment**: Assign shares to specific holders
- **Metadata**: Labels, tags, and custom metadata for shares

## Quick Start

```typescript
import { VeilKey, ShareManager } from '@veilkey/core';

// 1. Generate threshold keys
const keyGroup = await VeilKey.generate({
  threshold: 3,
  parties: 5,
  algorithm: 'RSA-2048'
});

// 2. Create share manager
const manager = new ShareManager({
  storage: 'file',
  storagePath: './shares.json',
  enableAudit: true,
});
await manager.init();

// 3. Store encrypted shares
const shareIds = await manager.storeShares(keyGroup, {
  password: 'secure-password-123',
  labels: ['Alice', 'Bob', 'Charlie', 'Diana', 'Eve'],
  tags: ['election-2024', 'production'],
});

// 4. Create holders
const alice = await manager.createHolder({
  name: 'Alice',
  role: 'trustee',
  contact: 'alice@example.com',
});

// 5. Assign share to holder
await manager.assignShare(shareIds[0], alice.id);

// 6. Retrieve share (requires password)
const { share, metadata } = await manager.getShare(
  shareIds[0],
  alice.id,
  { password: 'secure-password-123' }
);

// 7. Use share for threshold operations
const ciphertext = await VeilKey.encrypt(plaintext, keyGroup);
const partial = await VeilKey.partialDecrypt(ciphertext, share, keyGroup);
```

## Architecture

### Components

1. **ShareManager** (`index.ts`): Main class coordinating all operations
2. **Crypto** (`crypto.ts`): AES-256-GCM encryption with PBKDF2
3. **Storage** (`storage.ts`): Memory and file-based storage backends
4. **Access Control** (`access-control.ts`): RBAC implementation
5. **Audit** (`audit.ts`): Hash-chained audit logging

### Data Flow

```
┌─────────────────────────────────────────────────────────┐
│                    ShareManager                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  storeShares()          getShare()         assignShare()│
│       ↓                     ↓                    ↓      │
│  ┌─────────┐          ┌─────────┐         ┌─────────┐  │
│  │ Crypto  │          │ Access  │         │ Storage │  │
│  │ encrypt │          │ Control │         │         │  │
│  └────┬────┘          └────┬────┘         └────┬────┘  │
│       ↓                    ↓                   ↓        │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Storage Backend                    │   │
│  │      (MemoryStorage | FileStorage)              │   │
│  └─────────────────────────────────────────────────┘   │
│                          ↓                             │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Audit Logger                       │   │
│  │           (Hash-chained log)                    │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

## Storage Backends

### Memory Storage

For testing and development:

```typescript
const manager = new ShareManager({
  storage: 'memory',
});
```

- Data lost on process exit
- Fast and simple
- No file I/O

### File Storage

For production:

```typescript
const manager = new ShareManager({
  storage: 'file',
  storagePath: '/secure/path/shares.json',
});
```

- Persistent across restarts
- Automatic deferred writes (1s debounce)
- JSON format with Date support

## Access Control

### Roles

- **admin**: Full access to all operations
- **trustee**: Can read and use assigned shares
- **auditor**: Can read audit logs only

### Permissions

```typescript
type Permission =
  | 'share:create'    // Create new shares
  | 'share:read'      // Read share data
  | 'share:use'       // Use share for crypto operations
  | 'share:delete'    // Delete shares
  | 'share:assign'    // Assign shares to holders
  | 'holder:create'   // Create new holders
  | 'holder:read'     // Read holder data
  | 'holder:update'   // Update holders
  | 'holder:delete'   // Delete holders
  | 'audit:read'      // Read audit log
  | 'audit:export';   // Export audit log
```

### Custom Policies

```typescript
import { AccessControl } from '@veilkey/core';

const ac = new AccessControl();
ac.addPolicy({
  role: 'observer',
  permissions: ['audit:read', 'holder:read'],
});
```

## Audit Logging

All operations are logged in a tamper-evident hash chain:

```typescript
// Get audit log
const auditLog = await manager.getAuditLog();
console.log(`Total entries: ${auditLog.entries.length}`);

// Verify integrity
const verification = await manager.verifyAuditLog();
if (verification.valid) {
  console.log('Audit log integrity verified ✓');
} else {
  console.error('Audit log has been tampered with!');
  console.error(verification.errors);
}
```

### Audit Events

- `share.created`: Share encrypted and stored
- `share.accessed`: Share retrieved and decrypted
- `share.used`: Share used for signing/decryption
- `share.deleted`: Share removed
- `share.assigned`: Share assigned to holder
- `holder.created`: New holder created
- `holder.updated`: Holder information updated
- `holder.deleted`: Holder removed
- `audit.exported`: Audit log exported

### Hash Chain

Each entry contains:
- Hash of entry data
- Hash of previous entry (chain link)
- Timestamp, actor, resource, details

This makes tampering detectable - changing any entry breaks the chain.

## Encryption Details

### Algorithm

- **Cipher**: AES-256-GCM (authenticated encryption)
- **KDF**: PBKDF2-SHA256 (100,000 iterations default)
- **Salt**: 256-bit random
- **IV/Nonce**: 96-bit random (GCM recommended)
- **Auth Tag**: 128-bit (provides authentication)

### Share Data Structure

```typescript
interface EncryptedShare {
  id: string;              // UUID
  index: number;           // Share index (1-based)
  keyGroupId: string;      // Key group UUID
  ciphertext: string;      // Encrypted share (hex)
  salt: string;            // KDF salt (hex)
  iv: string;              // AES-GCM nonce (hex)
  authTag: string;         // GCM auth tag (hex)
  metadata: {
    label: string;
    tags: string[];
    algorithm: string;
    threshold: number;
    parties: number;
  };
  createdAt: Date;
  lastAccessedAt?: Date;
}
```

## Security Considerations

1. **Password Strength**: Use strong, random passwords (>= 20 characters)
2. **Key Derivation**: Default 100k iterations (OWASP minimum)
3. **Storage Security**: File storage should be on encrypted filesystem
4. **Access Control**: Enforce principle of least privilege
5. **Audit Logs**: Regularly verify integrity and export for backup
6. **Share Assignment**: Limit share access to necessary parties only

## Testing

Run tests:

```bash
npm test src/share-manager
```

Test coverage includes:
- Encryption/decryption
- Storage backends
- Access control
- Audit logging
- Share assignment
- Error handling
- Integration tests

## API Reference

### ShareManager

#### `constructor(config?: ShareManagerConfig)`

Create a new ShareManager.

#### `async init(): Promise<void>`

Initialize the manager. Must be called before use.

#### `async storeShares(keyGroup, options): Promise<string[]>`

Store encrypted shares from a key group.

#### `async getShare(shareId, holderId, options): Promise<ShareRetrievalResult>`

Retrieve and decrypt a share.

#### `async listShares(): Promise<EncryptedShare[]>`

List all stored shares (encrypted).

#### `async deleteShare(shareId, holderId): Promise<boolean>`

Delete a share (admin only).

#### `async createHolder(params): Promise<ShareHolder>`

Create a new share holder.

#### `async getHolder(holderId): Promise<ShareHolder | null>`

Get a holder by ID.

#### `async listHolders(): Promise<ShareHolder[]>`

List all holders.

#### `async updateHolder(holderId, updates): Promise<ShareHolder>`

Update holder information.

#### `async assignShare(shareId, holderId, expiresAt?): Promise<ShareAssignment>`

Assign a share to a holder.

#### `async getAssignmentsByHolder(holderId): Promise<ShareAssignment[]>`

Get all assignments for a holder.

#### `async unassignShare(shareId): Promise<boolean>`

Unassign a share.

#### `async getAuditLog(): Promise<AuditLog>`

Export the audit log.

#### `async verifyAuditLog(): Promise<VerificationResult>`

Verify audit log integrity.

#### `async close(): Promise<void>`

Close the manager and flush pending writes.

## Examples

### TVS Vote Tallying

```typescript
// Setup: Election officials generate keys
const election = await VeilKey.generate({
  threshold: 3,
  parties: 5,
  algorithm: 'RSA-2048'
});

const manager = new ShareManager({ storage: 'file' });
await manager.init();

const shareIds = await manager.storeShares(election, {
  password: process.env.ELECTION_PASSWORD,
  labels: ['Trustee 1', 'Trustee 2', 'Trustee 3', 'Trustee 4', 'Trustee 5'],
  tags: ['election-2024', 'county-general'],
});

// Create trustees
const trustees = await Promise.all([
  manager.createHolder({ name: 'Alice', role: 'trustee' }),
  manager.createHolder({ name: 'Bob', role: 'trustee' }),
  manager.createHolder({ name: 'Charlie', role: 'trustee' }),
  manager.createHolder({ name: 'Diana', role: 'trustee' }),
  manager.createHolder({ name: 'Eve', role: 'trustee' }),
]);

// Assign shares
for (let i = 0; i < shareIds.length; i++) {
  await manager.assignShare(shareIds[i], trustees[i].id);
}

// Tallying: 3 trustees participate
const shares = await Promise.all([
  manager.getShare(shareIds[0], trustees[0].id, { password }),
  manager.getShare(shareIds[2], trustees[2].id, { password }),
  manager.getShare(shareIds[4], trustees[4].id, { password }),
]);

// Decrypt votes
const partials = await Promise.all(
  shares.map(({ share }) =>
    VeilKey.partialDecrypt(encryptedVote, share, election)
  )
);

const aesKey = await VeilKey.combineDecryptions(
  encryptedVote,
  partials,
  election
);

// Verify audit trail
const verification = await manager.verifyAuditLog();
console.log('Audit verified:', verification.valid);
```

## License

Business Source License 1.1 (BSL-1.1)
